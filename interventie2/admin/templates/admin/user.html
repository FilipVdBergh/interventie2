{% extends 'base.html' %}

{% block steps %}
    {% if current_user.role.edit_users %}<a href="{{ url_for('admin.index') }}" class="step">Gebruikers</a>{% endif %}
{% endblock %}

{% block page_title %}
    {% if user == current_user %}
        Mijn account
    {% else %}
        {{ user.name }} 
    {% endif %}
{% endblock %}

{% block tabs %}
    {% if current_user == user %}
        <button class="tablinks" onclick="switch_tab(event, 'us_messages')" id="defaultOpen">Berichten</button>
    {% endif %}
    <button class="tablinks" onclick="switch_tab(event, 'us_info')"  id="defaultOpen">Informatie</button>
{% endblock %}

{% block body %}
<div id="us_messages" class="tabcontent">
    <div class="text_area">

        {% if current_user == user %}   

        <h1>Inbox</h1>
        {% if current_user.messages_list() | count > 0 %}
        <div class="card_area">
            {% for message in current_user.messages_list() %}
                <a href="{{ url_for('admin.message', message_id=message.id) }}">
                    <div class="card">
                        <div class="card_title">
                            {{ message.subject }} {% if message.unread %}(nieuw){% endif %}
                        </div>
                        <div class="card_info">
                            <p>
                                {% if message.system %}
                                    Systeem ({{ message.sender.name }})
                                {% else %}
                                    {{ message.sender.name }}
                                {% endif %}
                                , {{ message.date_created.strftime('%d-%m-%Y') }}.
                            </p> 
                        </div>
                        <div class="card_description">
                            {{ message.body | escape | truncate(200) | markdown }}
                        </div>
                    </div>
                </a>
            {% endfor %}
        </div>
        {% else %}
            <div>Geen berichten</div>
        {% endif %}

        <h1>Outbox</h1>
        {% if current_user.messages_sent | count > 0 %}
                <table class="sortable">
                    <thead>
                        <tr>
                            <th>Onderwerp</th>
                            <th>Ontvanger</th>
                            <th>Datum</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for message in current_user.messages_sent %}
                        <tr>
                            <td><a href="{{ url_for('admin.message', message_id=message.id) }}" {% if message.unread %} class="unread"{% endif %}>{{ message.subject }}</a></td>
                            <td><a href="{{ url_for('admin.user', id=message.recipient.id) }}">{{ message.recipient.name }}</a></td>
                            <td>{{ message.date_created }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                </table>
        {% else %}
            <div class="collapsible_content">Geen berichten</div>
        {% endif %}
        <br>

    {% endif %}
    </div>
</div>

<div id="us_info" class="tabcontent">
    <div class="text_area">
        <a href="{{ url_for('admin.edit_user', user_id=user.id) }}"><button>✎ Gebruiker aanpassen</button></a>


        <h1>{{ user.name}}</h1>
        {% if user.description | length > 0 %}
            <div>{{ user.description }}</div>
        {% endif %}

        {% if user.email | length > 0 or user.link | length > 0 %}
            <h2>Overige gegevens</h2>
        {% endif %}
        <ul>
            {% if user.email | length > 0 %}
                <li>
                    <div><a href="mailto:{{ user.email}}">{{ user.email }}</a></div>
                </li>
            {% endif %}
            {% if user.link | length > 0 %}
                <li>
                    <div><a href="{{ user.link }}">{{ user.link }}</a></div>
                </li>
            {% endif %}            
        </ul>

        <h2>Inloggegevens</h2>
        <ul>
            <li>Rol: <a href="{{ url_for('admin.roles') }}">{{ user.role.name }}</a></li>
            <li>{% if user.active %}Inloggen is toegestaan{% else %}Inloggen is niet toegestaan{% endif %}</li>
            <li>Gebruiker aangemaakt: {{ user.date_created }}</li>
            <li>Gebruiker laatst ingelogd: {{ user.last_seen }}</li>
        </ul>

        <h1>Opties</h1>
        <ul>
            {% if user == current_user %}<a href="{{ url_for('main.logout') }}"><li class="option">Uitloggen</li></a>{% endif %}
            <a href="{{ url_for('admin.change_password', user_id=user.id) }}"><li class="option">Wachtwoord veranderen</li></a>
            <!-- <a href="{{ url_for('admin.new_message', recipient_id=user.id) }}"><li class="option">Stuur {{ user.name }} een bericht</li></a> -->
            <li>{{ macro.confirm_redirect( "Gebruiker verwijderen", user.name+" verwijderen?", url_for('admin.delete_user', user_id=user.id) ) }}</li>
        </ul>

    </div>
</div>

{% endblock %}